---
title: "PERFect: method validation for Bacterial Diversity in Neonatal Intensive Care Units (NICUs) data"
author: "Ekaterina Smirnova"
date: "`r date()`"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
vignette: >
  %\VignetteIndexEntry{Simulations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}  
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, echo = FALSE,fig.align='center')
```



```{r required_libraries}

rm(list=ls())
library(Matrix)
library(devtools)
require(ggplot2)
require(sn)
require(fitdistrplus)
require(psych) 
library(PERFect) #install_github("katiasmirn/PERFect")
library(dirmult)
library(HMP)
library(knitr)
library(gridExtra)
library(grid)
library(reshape2)
library(kableExtra)
library(zoo)

set.seed(12341)
setwd("~/Dropbox/PERFect/RCode/")
source("~/Dropbox/PERFect/RCode/SimData.R")
pathtodata <- "~/Dropbox/PERFect/RCode/Responses/Rdata/"
```

These data (Knights et al., 2011) with with 30 samples and 1097 was collected to investigate the sources of bacteria found on surfaces and equipment in NICU. The data taxa was previously analyzed using sourcetracker software to identify the proportion of bacteria from each environment using published datasets from environments likely to be sources of indoor contaminants, namely human skin, oral cavities, feces and temperate soils. The sourcetracker results (see Table 1) reveal that in most NICU samples, the largest proportion of microbial communities come from the skin and unknown OTU samples, however this software does not specify which taxa are predicted in each environment.

```{r}
results <- readRDS("C:/Users/Kwee/Dropbox/Quy/PERFect/PERFect-master/Analyses/Knights_data/ST.rds")
res.NICU <- results$proportions[match(rownames(NICU.counts), rownames(results$proportions)),]
labels.NICU <- sprintf('%s %s', envs,desc)[test.ix]
labels.NICU <- labels.NICU[match(rownames(NICU.counts), rownames(results$proportions))]
rownames(res.NICU) <- labels.NICU

df <- data.frame( round(res.NICU, 4))

#kable(df,format="latex",booktabs=TRUE,caption="Sourcetracker results: estimated proportion of taxa from each environment in NICU samples (Knights et al, 2011)") %>% kable_styling(latex_options = c("striped", "hold_position"))

df <- data.frame(rownames(res.NICU), round(res.NICU, 4))
names(df)[1]<- ""
kable(df, row.names = FALSE)

```



```{r}
#NICU.counts

#identify taxa from each source that appears in NICU samples

#select NICU counts from gut environment
NICU.gut.otu <- intersect(colnames(NICU.counts), gut.nzero.otu)

#select NICU counts from skin environment but not in gut environment
NICU.skin.otu <- intersect(colnames(NICU.counts), skin.nzero.otu)

#select NICU counts from soil environment
NICU.soil.otu <- intersect(colnames(NICU.counts), soil.nzero.otu)

#select NICU counts from oral environment
NICU.oral.otu <- intersect(colnames(NICU.counts), oral.nzero.otu)

#remove unknown OTUs. All OTUs that are not present in either environment
NICU.unknown.otu <- setdiff(colnames(NICU.counts),c(NICU.gut.otu, NICU.skin.otu, NICU.soil.otu, NICU.oral.otu))


#create taxa info table for taxa found in each environment
taxa <- colnames(NICU.counts)
skin <- taxa %in% NICU.skin.otu
oral <- taxa %in% NICU.oral.otu
gut <-  taxa %in% NICU.gut.otu
soil <- taxa %in% NICU.soil.otu
unknown <- taxa %in% NICU.unknown.otu

#soil <- ifelse(soil == TRUE,1,0)

#common otus
skin.oral <- ifelse(skin*oral == 1, TRUE, FALSE)
skin.gut <- ifelse(skin*gut == 1, TRUE, FALSE)
skin.soil <- ifelse(skin*soil == 1, TRUE, FALSE)
oral.gut <- ifelse(oral*gut == 1, TRUE, FALSE)
oral.soil <- ifelse(oral*soil == 1, TRUE, FALSE)
gut.soil <- ifelse(gut*soil == 1, TRUE, FALSE)

skin.oral.gut <- ifelse(skin*oral*gut == 1, TRUE, FALSE)
skin.oral.gut.soil <- ifelse(skin*oral*gut*soil == 1, TRUE, FALSE)

#combine into a data frame that records all taxa that appear in each environment
taxaInfo <- data.frame(taxa = taxa, 
                 name = otu_id$name[match(taxa, otu_id$id)],
                 env = taxa)
taxaInfo$env <- as.character(taxaInfo$env)
taxaInfo$env[skin] <- "skin"
taxaInfo$env[oral] <- "oral"
taxaInfo$env[gut] <- "gut"
taxaInfo$env[soil] <- "soil"
taxaInfo$env[unknown] <- "unknown"

taxaInfo$env[skin.oral] <- "skin.oral"
taxaInfo$env[skin.gut] <- "skin.gut"
taxaInfo$env[skin.soil] <- "skin.soil"
taxaInfo$env[oral.gut] <- "oral.gut"
taxaInfo$env[oral.soil] <- "oral.soil"
taxaInfo$env[gut.soil] <- "gut.soil"

taxaInfo$env[skin.oral.gut] <- "skin.oral.gut"
taxaInfo$env[skin.oral.gut.soil] <- "skin.oral.gut.soil"

#arrange taxa in prevalence order NP
#head is least doninant, tail is most dominant
NP <- NP_Order(NICU.counts)
taxaInfo <- taxaInfo[match(NP, taxaInfo$taxa),]
taxaInfo$taxa <- factor(taxaInfo$taxa, levels = NP)
taxaInfo$env <- factor(taxaInfo$env, levels = c("skin", "soil", "oral", "gut", "unknown",
                                    "skin.oral", "skin.gut", "skin.soil", "gut.soil",
                                    "skin.oral.gut", "skin.oral.gut.soil"))
```

Dimension of the data set

```{r}
dim(NICU.counts)
Counts <- NICU.counts
```



#PERFect validation metrics

We evaluate robustness of  PERFect to the choice of quantiles used to fit the Skew-Normal distribution to the logarithm of the sample $DFL(j+1), ~j=1, \dots, p-1$, where $p$ is the total number of taxa and choose: a) 5\%, 10\%, 25\%; b) 10\%, 25\%, 40\%; c) 10\%, 25\%, 50\%; and d) 20\%, 30\%, 60\% quantiles to match. We  compare PERFect performance to  traditional filtering and decontam results in terms of:

1. Total number/percentage of OTUs left in the final data set

2. Total number/percentage of OTU in each environment category

3. Comparison with features identified as contaminants by sourcetracker and decontam packages

4. Ranking of PERFect p-values in terms of feature abundance presented as plot, with taxa sorted by the decreasing order of p-values and  colored by the abundance  quantiles.


```{r}
#function to output results for each simulation run
resSummary <-function(X, filtX, taxaInfo, pvals = NULL, time){
  
  rank_pvals = NULL 
  rank_pres = NULL
  ntotal <- dim(X)[2]
  npres <- dim(filtX)[2] #number of taxa left
  
  pfilt <- (ntotal - npres)/ntotal #percentage of taxa filtered
  
  taxaInfofilt <- taxaInfo[taxaInfo$taxa %in% colnames(filtX), ]
  ntot_env <- c()
  npres_env <-c()
  ppres_env <- c()
  taxa_env <- sapply(levels(taxaInfo$env),function(x) NULL)
    for(i in 1:length(levels(taxaInfo$env))){
      
      env <- levels(taxaInfo$env)[i]
      ntot_env <- c(ntot_env, sum(taxaInfo$env == env)) #total number in environment  
      npres_env <- c(npres_env, sum(taxaInfofilt$env == env)) #number present in environment
      #taxa names in each environment
      taxa_env[[i]]<- taxaInfo$taxa[taxaInfo$env == env]
    }
  
  names(ntot_env) <- levels(taxaInfo$env)
  names(npres_env) <- levels(taxaInfo$env)
  #relative number in each environment
  nrel_env <-  ntot_env/ntotal
  
  #relative number in each environment after filtering
  ppres_env <- npres_env/npres
  
  #ranking of preserved features relative to the features prevalence level
  rank <- match(colnames(filtX), rev(taxaInfo$taxa))#since taxa already arranged in prevalence order
  
  if(!is.null(pvals)){
    #ranking of p-values for each feature relative to prevalence level
    rank_pvals <- match(names(sort(pvals, decreasing = TRUE)), rev(taxaInfo$taxa))
    #ranks of p-values for the filtered taxa
    rank_pres_pvals <- match(names(sort(pvals, decreasing = TRUE)), rev(colnames(filtX)))
    rank_pres_pvals <- rank_pres_pvals[!is.na(rank_pres_pvals)]
    #rank of filtered taxa
    rank_pres <- cbind(rank, rank_pres_pvals)
    colnames(rank_pres) <- c("prev", "pvals")
    rownames(rank_pres) <- colnames(filtX)
  }
  #combine into results vector
  res <- c(ntotal, npres, pfilt)
  names(res) <- c("ntotal", "npres", "pfilt")
  res_env <- cbind(ntot_env, nrel_env, npres_env, ppres_env)
  
  
  return(list(res = res, res_env = res_env, rank_pvals = rank_pvals, rank_pres = rank_pres,
              time = time, taxa_env = taxa_env))
  
}
```

##Results

1. Simultaneous PERFect with skew-normal distribution and NP ordering. 

```{r}

#########################
#quantiles from fit a
##########################
start <- Sys.time()
res_sim_sn_a <- PERFect_sim(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.05,0.10, 0.25), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
summary_sim_sn_a <- resSummary(X = Counts, filtX = res_sim_sn_a$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a$pvals, time = end)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_a$pvals, alpha = 0.05)
summary_sim_sn_a_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_a$pvals, alpha = 0.15)
summary_sim_sn_a_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a$pvals, time = NA)


#########################
#quantiles from fit b
##########################
start <- Sys.time()
res_sim_sn_b <- PERFect_sim(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.1,0.25, 0.40), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_b <- resSummary(X = Counts, filtX = res_sim_sn_b$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_b$pvals, alpha = 0.05)
summary_sim_sn_b_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_b$pvals, alpha = 0.15)
summary_sim_sn_b_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b$pvals, time = NA)
#########################
#quantiles from fit c
##########################
start <- Sys.time()
res_sim_sn_c <- PERFect_sim(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.1,0.25, 0.50), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_c <- resSummary(X = Counts, filtX = res_sim_sn_c$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_c$pvals, alpha = 0.05)
summary_sim_sn_c_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_c$pvals, alpha = 0.15)
summary_sim_sn_c_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c$pvals, time = NA)

#########################
#quantiles from fit d
##########################
start <- Sys.time()
res_sim_sn_d <- PERFect_sim(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.20,0.30, 0.60), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_d <- resSummary(X = Counts, filtX = res_sim_sn_d$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d$pvals, time = NA)


#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_d$pvals, alpha = 0.05)
summary_sim_sn_d_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_d$pvals, alpha = 0.15)
summary_sim_sn_d_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d$pvals, time = NA)
```


1. Simultaneous PERFect with skew-normal distribution and p-values ordering. 

```{r}

#########################
#quantiles from fit a
##########################
start <- Sys.time()
res_sim_sn_a_pvals <- PERFect_sim(X=Counts,  Order="pvals",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", pvals_sim = res_sim_sn_a,
                       quant = c(0.05,0.10, 0.25), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
summary_sim_sn_a_pvals <- resSummary(X = Counts, filtX = res_sim_sn_a_pvals$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a_pvals$pvals, time = end)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_a_pvals$pvals, alpha = 0.05)
summary_sim_sn_a_0.05_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a_pvals$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_a_pvals$pvals, alpha = 0.15)
summary_sim_sn_a_0.15_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_a_pvals$pvals, time = NA)


#########################
#quantiles from fit b
##########################
start <- Sys.time()
res_sim_sn_b_pvals <- PERFect_sim(X=Counts,  Order="pvals",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", pvals_sim = res_sim_sn_b,
                       quant = c(0.1,0.25, 0.40), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_b_pvals <- resSummary(X = Counts, filtX = res_sim_sn_b_pvals$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b_pvals$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_b_pvals$pvals, alpha = 0.05)
summary_sim_sn_b_0.05_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b_pvals$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_b_pvals$pvals, alpha = 0.15)
summary_sim_sn_b_0.15_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_b_pvals$pvals, time = NA)
#########################
#quantiles from fit c
##########################
start <- Sys.time()
res_sim_sn_c_pvals <- PERFect_sim(X=Counts,  Order="pvals",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", pvals_sim = res_sim_sn_c,
                       quant = c(0.1,0.25, 0.50), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_c_pvals <- resSummary(X = Counts, filtX = res_sim_sn_c_pvals$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c_pvals$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_c_pvals$pvals, alpha = 0.05)
summary_sim_sn_c_0.05_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c_pvals$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_c_pvals$pvals, alpha = 0.15)
summary_sim_sn_c_0.15_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_c_pvals$pvals, time = NA)

#########################
#quantiles from fit d
##########################
start <- Sys.time()
res_sim_sn_d_pvals <- PERFect_sim(X=Counts,  Order="pvals",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", pvals_sim = res_sim_sn_b,
                       quant = c(0.20,0.30, 0.60), hist_fill =0.2, linecol = "blue",
                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for sumultaneous PERFect with NP ordering
summary_sim_sn_d_pvals <- resSummary(X = Counts, filtX = res_sim_sn_d_pvals$filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d_pvals$pvals, time = NA)


#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_sim_sn_d_pvals$pvals, alpha = 0.05)
summary_sim_sn_d_0.05_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d_pvals$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_sim_sn_d_pvals$pvals, alpha = 0.15)
summary_sim_sn_d_0.15_pvals <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_sim_sn_d_pvals$pvals, time = NA)
```



The histogram of log differences in filtering loss for the simultaneous PERFect method shows that the method is generally robust to the choice of quantiles used to fit the Skew-Normal distribution. 


```{r}
#Manual fit to display all 4 quantile fits on one graph 
hist <- res_sim_sn_a$hist + stat_function(fun = dsn, aes(linetype = "Q1"),
      args = list(xi = res_sim_sn_a$est[1], omega = res_sim_sn_a$est[2], 
                  alpha = res_sim_sn_a$est[3]), colour="blue")+
      stat_function(fun = dsn, aes(linetype = "Q2"),
      args = list(xi = res_sim_sn_b$est[1], omega = res_sim_sn_b$est[2], 
                  alpha = res_sim_sn_b$est[3]), colour="blue")+ 
      stat_function(fun = dsn, aes(linetype = "Q3"),
      args = list(xi = res_sim_sn_c$est[1], omega = res_sim_sn_c$est[2], 
                  alpha = res_sim_sn_c$est[3]), colour="blue")+ 
      stat_function(fun = dsn, aes(linetype = "Q4"),
      args = list(xi = res_sim_sn_d$est[1], omega = res_sim_sn_d$est[2], 
                  alpha = res_sim_sn_d$est[3]), colour="blue")+
      scale_linetype_manual("", values = c("solid", "dashed", "dotted", "twodash"),
                            labels = c("5%, 10%, 25%", "10%, 25%, 40%", 
                                       "10%, 25%, 50%", "20%, 30%, 60%"))+
      theme(legend.position=c(0.6,0.8))
hist
ggsave("~/Dropbox/PERFect/RCode/Responses/Plots/Quantiles_Knights.pdf")
```


2. Permutation PERFect with skew-normal distribution NP ordering.


```{r}

start <- Sys.time()
res_perm_a <- PERFect_perm(X=Counts,  Order="NP",  nbins = 30, col = "red", k = 10000,
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.05,0.10, 0.25), hist_fill =0.2, linecol = "blue",
                        lag = 3, direction ="left")
(end <-  Sys.time()-start)
#save results
#saveRDS(res_perm_a, file = paste0(pathtodata, "res_perm_NICU_a.RDS"))
#saveRDS(end, file = paste0(pathtodata, "time_NICU_a.RDS"))
#read results for faster processing
#res_perm_a <- readRDS(file = paste0(pathtodata, "res_perm_NICU_a.RDS"))
#end <- readRDS(file = paste0(pathtodata, "time_NICU_a.RDS"))
#very normal looking for these data
#res_perm_a$hist[[200]]
#results for permutation PERFect with NP ordering
summary_perm_np_a <- resSummary(X = Counts, filtX = res_perm_a$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_a$pvals, time = end)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_a$pvals, alpha = 0.05)
summary_perm_np_a_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_a$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_a$pvals, alpha = 0.15)
summary_perm_np_a_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_a$pvals, time = NA)
#########################
#quantiles from fit b
##########################
start <- Sys.time()
res_perm_b <- PERFect_perm(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.1,0.25, 0.40), hist_fill =0.2, linecol = "blue",
                       dfl_distr = res_perm_a$dfl_distr,
                       lag = 3, direction ="left")
(end <-  Sys.time()-start)
#saveRDS(res_perm_b, file = paste0(pathtodata, "res_perm_NICU_b.RDS"))
#read results for faster processing
#res_perm_b <- readRDS(file = paste0(pathtodata, "res_perm_NICU_b.RDS"))
#results for sumultaneous PERFect with NP ordering
summary_perm_np_b <- resSummary(X = Counts, filtX = res_perm_b$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_b$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_b$pvals, alpha = 0.05)
summary_perm_np_b_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_b$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_b$pvals, alpha = 0.15)
summary_perm_np_b_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_b$pvals, time = NA)
#########################
#quantiles from fit c
##########################
start <- Sys.time()
res_perm_c <- PERFect_perm(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.1,0.25, 0.50), hist_fill =0.2, linecol = "blue",
                       dfl_distr = res_perm_a$dfl_distr, lag = 3, direction ="left")
(end <-  Sys.time()-start)
#saveRDS(res_perm_c, file = paste0(pathtodata, "res_perm_NICU_c.RDS"))

#read results for faster processing
#res_perm_c <- readRDS(file = paste0(pathtodata, "res_perm_NICU_c.RDS"))
#results for sumultaneous PERFect with NP ordering
summary_perm_np_c <- resSummary(X = Counts, filtX = res_perm_c$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_c$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_c$pvals, alpha = 0.05)
summary_perm_np_c_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_c$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_c$pvals, alpha = 0.15)
summary_perm_np_c_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_c$pvals, time = NA)
#########################
#quantiles from fit d
##########################
start <- Sys.time()
res_perm_d <- PERFect_perm(X=Counts,  Order="NP",  nbins = 30, col = "red", 
                       fill = "green", alpha = 0.1, distr = "sn", 
                       quant = c(0.20,0.30, 0.60), hist_fill =0.2, linecol = "blue",
                       dfl_distr = res_perm_a$dfl_distr, lag = 3, direction ="left")
(end <-  Sys.time()-start)

#saveRDS(res_perm_d, file = paste0(pathtodata, "res_perm_NICU_d.RDS"))


#read results for faster processing
#res_perm_d <- readRDS(file = paste0(pathtodata, "res_perm_NICU_d.RDS"))

#results for sumultaneous PERFect with NP ordering
summary_perm_np_d <- resSummary(X = Counts, filtX = res_perm_d$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_d$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_d$pvals, alpha = 0.05)
summary_perm_np_d_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_d$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_d$pvals, alpha = 0.15)
summary_perm_np_d_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_d$pvals, time = NA)
```

3. Permutation perfect with simultaneous p-values ordering from simultaneous PERFect with Skew Normal fit 


```{r}

start <- Sys.time()
res_perm_pvals_a <- PERFect_perm_reorder(X=Counts,  Order = "pvals",  
                                       pvals_sim = res_sim_sn_a,
                                       res_perm = res_perm_a, alpha = 0.1, distr = "sn",
                                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for permutation PERFect with NP ordering
summary_perm_pvals_a <- resSummary(X = Counts, filtX = res_perm_pvals_a$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_a$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_a$pvals, alpha = 0.05)
summary_perm_pvals_a_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_a$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_a$pvals, alpha = 0.15)
summary_perm_pvals_a_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_a$pvals, time = NA)
#########################
#quantiles from fit b
##########################

start <- Sys.time()
res_perm_pvals_b <- PERFect_perm_reorder(X=Counts,  Order = "pvals",  
                                       pvals_sim = res_sim_sn_b,  
                                       res_perm = res_perm_b, alpha = 0.1, distr = "sn",
                                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for permutation PERFect with NP ordering
summary_perm_pvals_b <- resSummary(X = Counts, filtX = res_perm_pvals_b$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_b$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_b$pvals, alpha = 0.05)
summary_perm_pvals_b_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_b$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_b$pvals, alpha = 0.15)
summary_perm_pvals_b_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_b$pvals, time = NA)
#########################
#quantiles from fit c
##########################

start <- Sys.time()
res_perm_pvals_c <- PERFect_perm_reorder(X=Counts,  Order = "pvals",  
                                       pvals_sim = res_sim_sn_c, 
                                       res_perm = res_perm_c, alpha = 0.1, distr = "sn",
                                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for permutation PERFect with NP ordering
summary_perm_pvals_c <- resSummary(X = Counts, filtX = res_perm_pvals_c$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_c$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_c$pvals, alpha = 0.05)
summary_perm_pvals_c_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_c$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_c$pvals, alpha = 0.15)
summary_perm_pvals_c_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_c$pvals, time = NA)

#########################
#quantiles from fit d
##########################

start <- Sys.time()
res_perm_pvals_d <- PERFect_perm_reorder(X=Counts,  Order = "pvals",  
                                       pvals_sim = res_sim_sn_d,
                                       res_perm = res_perm_d, alpha = 0.1, distr = "sn",
                                       lag = 3, direction ="left")
end <-  Sys.time()-start
#results for permutation PERFect with NP ordering
summary_perm_pvals_d <- resSummary(X = Counts, filtX = res_perm_pvals_d$filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_d$pvals, time = NA)

#apply two more p-values thresholds
filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_d$pvals, alpha = 0.05)
summary_perm_pvals_d_0.05 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_d$pvals, time = NA)

filtX <- filt_pval(X = Counts, pvals =res_perm_pvals_d$pvals, alpha = 0.15)
summary_perm_pvals_d_0.15 <- resSummary(X = Counts, filtX = filtX, 
                          taxaInfo = taxaInfo, pvals = res_perm_pvals_d$pvals, time = NA)

```

4. Decontam package results

Negative controls or DNA concentrations data is not available as a part of publically available data distributed with sourcetracker package. 

5. Traditional Filtering Rule 1

```{r}
start <- Sys.time()
#traditional filtering
res_trad <- TraditR1(Counts, thresh =5)
end <-  Sys.time()-start
#results for traditional filtering with NP ordering
summary_trad_r1 <- resSummary(X = Counts, filtX = res_trad, 
                          taxaInfo = taxaInfo, pvals = NULL, time= end)

```

6. Traditional Filtering Rule 2

```{r}

#traditional filtering
start <- Sys.time()
res_trad <- TraditR2(Counts)
end <-  Sys.time()-start
#results for traditional filtering with NP ordering
summary_trad_r2 <- resSummary(X = Counts, filtX = res_trad, 
                          taxaInfo = taxaInfo, pvals = NULL, time = end)

```

#Table of results comparison

1. Number of taxa present

```{r}
df <- rbind(summary_sim_sn_a_0.15$res,summary_sim_sn_b_0.15$res,
            summary_sim_sn_c_0.15$res,summary_sim_sn_d_0.15$res,
            summary_sim_sn_a$res,summary_sim_sn_b$res,
            summary_sim_sn_c$res,summary_sim_sn_d$res,
            summary_sim_sn_a_0.05$res,summary_sim_sn_b_0.05$res,
            summary_sim_sn_c_0.05$res,summary_sim_sn_d_0.05$res,
            summary_sim_sn_a_0.15_pvals$res,summary_sim_sn_b_0.15_pvals$res,
            summary_sim_sn_c_0.15_pvals$res,summary_sim_sn_d_0.15_pvals$res,
            summary_sim_sn_a_pvals$res,summary_sim_sn_b_pvals$res,
            summary_sim_sn_c_pvals$res,summary_sim_sn_d_pvals$res,
            summary_sim_sn_a_0.05_pvals$res,summary_sim_sn_b_0.05_pvals$res,
            summary_sim_sn_c_0.05_pvals$res,summary_sim_sn_d_0.05_pvals$res,
            summary_perm_np_a_0.15$res, summary_perm_np_b_0.15$res,
            summary_perm_np_c_0.15$res, summary_perm_np_d_0.15$res,
            summary_perm_np_a$res, summary_perm_np_b$res,
            summary_perm_np_c$res, summary_perm_np_d$res,
            summary_perm_np_a_0.05$res, summary_perm_np_b_0.05$res,
            summary_perm_np_c_0.05$res, summary_perm_np_d_0.05$res,
            summary_perm_pvals_a_0.15$res,summary_perm_pvals_b_0.15$res,
            summary_perm_pvals_c_0.15$res,summary_perm_pvals_d_0.15$res,
            summary_perm_pvals_a$res,summary_perm_pvals_b$res,
            summary_perm_pvals_c$res,summary_perm_pvals_d$res,
            summary_perm_pvals_a_0.05$res,summary_perm_pvals_b_0.05$res,
            summary_perm_pvals_c_0.05$res,summary_perm_pvals_d_0.05$res,
            summary_trad_r1$res, summary_trad_r2$res)
rownames(df) <- c("PERFect_sim_a_0.15", "PERFect_sim_b_0.15", 
                  "PERFect_sim_c_0.15", "PERFect_sim_d_0.15",
                  "PERFect_sim_a_0.10", "PERFect_sim_b_0.10", 
                  "PERFect_sim_c_0.10", "PERFect_sim_d_0.10",
                  "PERFect_sim_a_0.05", "PERFect_sim_b_0.05", 
                  "PERFect_sim_c_0.05", "PERFect_sim_d_0.05",
                  "PERFect_sim_a_pvals_0.15", "PERFect_sim_b_pvals_0.15", 
                  "PERFect_sim_c_pvals_0.15", "PERFect_sim_d_pvals_0.15",
                  "PERFect_sim_a_pvals_0.10", "PERFect_sim_b_pvals_0.10", 
                  "PERFect_sim_c_pvals_0.10", "PERFect_sim_d_pvals_0.10",
                  "PERFect_sim_a_pvals_0.05", "PERFect_sim_b_pvals_0.05", 
                  "PERFect_sim_c_pvals_0.05", "PERFect_sim_d_pvals_0.05",
                  "PERFect_perm_np_a_0.15","PERFect_perm_np_b_0.15",
                  "PERFect_perm_np_c_0.15","PERFect_perm_np_d_0.15",
                  "PERFect_perm_np_a_0.10","PERFect_perm_np_b_0.10",
                  "PERFect_perm_np_c_0.10","PERFect_perm_np_d_0.10",
                  "PERFect_perm_np_a_0.05","PERFect_perm_np_b_0.05",
                  "PERFect_perm_np_c_0.05","PERFect_perm_np_d_0.05",
                  "PERFect_perm_pvals_a_0.15","PERFect_perm_pvals_b_0.15",
                  "PERFect_perm_pvals_c_0.15","PERFect_perm_pvals_d_0.15",
                  "PERFect_perm_pvals_a_0.10","PERFect_perm_pvals_b_0.10",
                  "PERFect_perm_pvals_c_0.10","PERFect_perm_pvals_d_0.10",
                  "PERFect_perm_pvals_a_0.05","PERFect_perm_pvals_b_0.05",
                  "PERFect_perm_pvals_c_0.05","PERFect_perm_pvals_d_0.05",
                  "Trad_R1", "Trad_R2")
df[,3] <- round(df[,3], 4)*100


#kable(df,format="latex",booktabs=TRUE,caption="Sourcetracker results: estimated proportion of taxa from each environment in NICU samples (Knights et al, 2011)") %>% kable_styling(latex_options = c("striped", "hold_position"))

names_spaced <- c(
   'Total number<br/>of taxa', '# of taxa <br/> preserved', 
  'Percentage of <br/> filtered taxa')

kable(df, 
      format='html', 
      digits=2, 
      row.names=TRUE, 
      align='lcc', 
      col.names = names_spaced,
      escape = FALSE) 

res_Knights <- df
```

2. Running time for each method

```{r}
df <- data.frame(summary_sim_sn_a$time, summary_perm_np_a$time, 
                 summary_trad_r1$time, summary_trad_r2$time)
names(df) <- c("Simultaneous PERFect", "Permutation PERFect", "Traditional Rule 1", "Traditional Rule 2")

names_spaced <- c(
   'PERFect<br/> Simultaneous', 'PERFect<br/> Permutation', 
    'Traditional<br/> Rule 1', 'Traditional<br/> Rule 2')

kable(df, 
      format='html', 
      digits=4, 
      row.names=FALSE, 
      align='cccc', 
      col.names = names_spaced,
      escape = FALSE) 
```


3. Proportion of taxa preserved in each environment

```{r}
df <- rbind(t(summary_sim_sn_c$res_env[,c(1,3)]),
            t(summary_perm_np_c$res_env[,c(3)]),
            t(summary_perm_pvals_c$res_env[,c(3)]),
            t(summary_trad_r1$res_env[,c(3)]),
            t(summary_trad_r2$res_env[,c(3)]))
#df[-1,] <- 100*df[-1,]
method <- c("total" ,"PERFect_sim",
                  "PERFect_perm_np","PERFect_perm_pvals",
                  "Trad_R1","Trad_R2")

df <- data.frame( df)
rownames(df) <- method

names_spaced <- c(
   'Skin', 'Soil', 'Oral', 'Gut', 'Unknown',
   'Skin<br/> and Oral', 'Skin<br/> and Gut',
   'Skin<br/> and Soil', 'Gut<br/> and Soil',
   'Skin, Oral<br/> and Gut', 'Skin, Oral<br/>Gut, Soil')

kable(df, 
      format='html', 
      digits=2, 
      row.names=TRUE, 
      align='lccccccccccc', 
      col.names = names_spaced,
      escape = FALSE) %>% kable_styling(font_size = 11) 

env_Knights <- df

Knights <- list(res = res_Knights, env = env_Knights)

saveRDS(Knights, file = paste0(pathtodata, "test_Knights.RDS"))

```

#List of organisms preserved in each environment

```{r}
#taxa preserved in each environment by simultaneous PERFect method
PERFect_sim_taxa <- summary_sim_sn_c$taxa_env

#taxa preserved in each environment by permutation PERFect method with NP ordering
PERFect_perm_taxa <- summary_perm_np_c$taxa_env

#taxa preserved in each environment by permutation PERFect method with p-values ordering
PERFect_perm_pvals_taxa <- summary_perm_pvals_c$taxa_env
```

